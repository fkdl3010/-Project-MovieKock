<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.koreait.movie.dao.MainDao">
	
	<select id="my_write" parameterType="int" resultType="com.koreait.movie.dto.CommentDto">
		SELECT movie_no, comments_title, comment_date
		  FROM comments
		 WHERE user_no = #{user_no}
	</select>
	
	<select id="movie_info" parameterType="int" resultType="com.koreait.movie.dto.CommentDto">
	    SELECT movie_no, comments_title, comment_date
		  FROM comments
		 WHERE user_no = #{user_no}
	</select>
	
	<select id="mainList1" resultType="com.koreait.movie.dto.MovieDto">
		 SELECT B.*
		  FROM (SELECT ROWNUM AS RN, A.*
			      FROM (SELECT ROW_NUMBER() OVER(PARTITION BY M.movie_title ORDER BY DBMS_RANDOM.RANDOM)AS RNUM,
                        M.*, G.GENRE_NAME
					     FROM MOVIE M, MOVIE_GENRE MG, GENRE G
						WHERE M.MOVIE_NO = MG.MOVIE_NO
					  	  AND G.GENRE_NO = MG.GENRE_NO
					  	<if test="today=='월'">AND G.GENRE_NO IN (3, 7)</if>
					     <if test="today=='화'">AND G.GENRE_NO IN (9, 11)</if>
					     <if test="today=='수'">AND G.GENRE_NO IN (10, 12)</if>
					     <if test="today=='목'">AND G.GENRE_NO IN (8, 11)</if>
					     <if test="today=='금'">AND G.GENRE_NO IN (5, 9)</if>
					     <if test="today=='토'">AND G.GENRE_NO IN (1, 2)</if>
					     <if test="today=='일'">AND G.GENRE_NO IN (1, 5)</if>
					     ORDER BY DBMS_RANDOM.RANDOM)A
                     WHERE RNUM = 1) B
		 <![CDATA[WHERE B.RN <= 12]]>
	</select>

	<select id="mainList2" resultType="com.koreait.movie.dto.MovieDto">
		SELECT *
		FROM MOVIE
		<![CDATA[WHERE ROWNUM <= 12]]>
	</select>

	<select id="mainList3" resultType="com.koreait.movie.dto.MovieDto">
		SELECT *
		FROM MOVIE
		<![CDATA[WHERE ROWNUM <= 12]]>
	</select>
	
	<select id="mainList4" resultType="com.koreait.movie.dto.MovieDto">
		SELECT *
		FROM MOVIE
		<![CDATA[WHERE ROWNUM <= 12]]>
		ORDER BY MOVIE_OPENING_DATE DESC
	</select>
	
	<select id="mainList5" resultType="com.koreait.movie.dto.MovieDto">
		SELECT *
		FROM (
			SELECT *
			FROM MOVIE
			WHERE MOVIE_NATION ='한국'
			ORDER BY DBMS_RANDOM.RANDOM
			)
		<![CDATA[WHERE ROWNUM <= 12]]>
	</select>
	
	<select id="resultList" parameterType="String" resultType="com.koreait.movie.dto.MovieDto">
		SELECT *
		FROM MOVIE
		WHERE MOVIE_TITLE LIKE '%'|| #{search} || '%'
			OR MOVIE_DIRECTOR LIKE '%'|| #{search} || '%'
			OR MOVIE_AUDIENCE LIKE '%'|| #{search} || '%'
			OR MOVIE_NATION LIKE '%'|| #{search} || '%'
	</select>
	
	<select id="userGenreList" parameterType="int" resultType="com.koreait.movie.dto.MovieDto">
		select e.*
		from (select rownum as rn, d.*
		     from (
		        select c.movie_no, c.movie_title, c.movie_director, c.movie_audience, c.movie_opening_date, c.movie_nation,LISTAGG(f.genre_name, ',') within group (order by f.genre_name) as genre_name
		        from movie_taste a, movie_genre b, movie c, genre f
		        where b.genre_no = a.genre_no
		        and b.movie_no = c.movie_no
		        and b.genre_no = f.genre_no
		        and a.user_no = #{userNo}
		        group by c.movie_no,c.movie_no, c.movie_title, c.movie_director, c.movie_audience, c.movie_opening_date, c.movie_nation
		        order by DBMS_RANDOM.RANDOM) d) e
		where e.rn between 1 and 12
	</select>
</mapper>
	
